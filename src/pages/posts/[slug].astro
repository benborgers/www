---
import Layout from '../../layouts/Layout.astro'
import Prose from '../../components/Prose.astro'
import { Code } from 'astro/components'
import getPosts, { POST_SOURCE } from '../../lib/getPosts'

export async function getStaticPaths() {
  const posts = await getPosts(Astro.fetchContent('../../../posts/*.md'))
  return posts.map(post => {
    return {
      params: { slug: post.slug },
      props: { post }
    }
  })
}

const { post } = Astro.props
---

<Layout title={`${post.title} - Ben Borgers`}>
  <div class="space-y-1 sm:space-y-2">
    <h1 class="text-3xl text-gray-900 font-black font-serif">{post.title}</h1>
    <p class="text-gray-400 font-medium">{
      new Date(post.date).toLocaleString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
      })
    }</p>
  </div>

  <div class="mt-8" />

  <Prose>
    {post.source === POST_SOURCE.FILE && (
      <link rel="stylesheet" href="https://unpkg.com/prism-themes@1.9.0/themes/prism-dracula.min.css" />

      <Fragment set:html={post.html} />
    )}

    {post.source === POST_SOURCE.GHOST && (() => {
      const pieces = post.html.split(/<\/?pre>/)

      return pieces.map(piece => {
        if (piece.startsWith('<code')) {
          const language = piece.match(/class="language-(.+?)"/)[1]
          const code = piece.match(/<code .*>(.+?)<\/code>/s)[1]
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')

          return <Code code={code} lang={language} theme="dracula" />
        }

        return <Fragment set:html={piece} />
      })
    })}
  </Prose>
</Layout>
