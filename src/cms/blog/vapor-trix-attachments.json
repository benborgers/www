{
  "published": true,
  "date": "2020-06-28T00:00:00.000Z",
  "title": "Handling Trix file attachments on Laravel Vapor",
  "slug": "vapor-trix-attachments",
  "description": "Uploading attachments to Amazon S3 and persisting them when using Basecamp's Trix editor and Laravel Vapor's serverless deployment. ",
  "body": "After a couple hours of work, I've finally gotten file attachments with Basecamp's Trix editor to work on Laravel Vapor. \n\nTo start, let's assume you have a basic Trix form set up, which mirrors its contents into an `input`. Getting to this point is fairly straightforward with the [Trix docs](https://github.com/basecamp/trix). \n\n```html\n<input type=\"hidden\" name=\"body\" id=\"body\" />\n<trix-editor input=\"body\"></trix-editor>\n```\n\nWhen the form with this input is submitted, I can grab the HTML in my Laravel controller like this: \n\n```php\n$body = request('body');\n```\n\n## The plan\n\nWith Laravel Vapor, you upload your files to Amazon S3 from the client-side. They go into a `tmp/` folder, where files are cleared when they're more than 24 hours old. \n\nOnce you're sure a file in the `tmp/` folder should be kept (i.e. the user really submitted the form), you copy it out of the `tmp/` folder to keep it around permanently. \n\nWe want to upload attachments to the `tmp/` folder in S3 as soon as they're dragged into the Trix editor, and keep track of which attachments are still in the Trix document. If the attachment is removed from Trix before the form is submitted, we don't want to copy that attachment out of `tmp/`.\n\n## Setup\n\nThere's some setup required to make sure this works when you develop locally. \n\n## Creating a bucket\n\nFirst, [attach a storage bucket](https://docs.vapor.build/1.0/resources/storage.html) in your `vapor.yml` file: \n\n```yaml\n# Abbreviated for clarity\n\nenvironments:\n  production:\n    storage: my-bucket\n```\n\nThen, deploy your project to Vapor. This will automatically create a bucket in S3 called `my-bucket`, which you can inspect in the S3 Console of your AWS account. \n\n## Allowing users to upload to the bucket\n\nPer the [Laravel Vapor docs](https://docs.vapor.build/1.0/resources/storage.html#authorization), we need to create a policy that allows users to upload files to the bucket. Run this command to create the policy:\n\n```bash\nphp artisan make:policy UserPolicy --model=User\n```\n\nAnd then add a function to the newly created policy file that allows any user to upload files: \n\n```php\npublic function uploadFiles(User $user)\n{\n  return true;\n}\n```\n\n## Local access to the bucket\n\nIn order to access this bucket from your local environment too, modify or add these values in your `.env` file: \n\n```\nFILESYSTEM_DRIVER=s3\n\nAWS_ACCESS_KEY_ID=\nAWS_SECRET_ACCESS_KEY=\nAWS_DEFAULT_REGION=us-east-1\nAWS_BUCKET=my-bucket\n```\n\nYou'll need to generate a set of IAM credentials for AWS, so you can access the S3 bucket locally. When developing locally, Vapor uploads files to the bucket specified under `AWS_BUCKET` using the IAM access keys provided. To keep things simple, we'll upload to the same bucket that we'll use in production (the one we created in `vapor.yml`). \n\n## Making the bucket's contents public\n\nYou'll also need to open your S3 bucket up to public read access. This is so that Trix can display temporary files that are dragged in, and so that you can show the persisted files later (after they're copied out of `tmp/`). \n\nLog in to the [S3 Console](https://s3.console.aws.amazon.com/), and select the bucket you just created. Go to the **Permissions** tab, then **Bucket Policy**. Paste in the following policy, replacing \"`my-bucket`\" with your bucket's name: \n\n```\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"PublicReadGetObject\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::my-bucket/*\"\n    }\n  ]\n}\n```\n\nKeep in mind that this makes every file in the bucket public (that is, if someone is given the randomly generated filename). \n\n## Installing dependencies\n\nYou'll need to install Vapor's javascript package to upload files from the frontend: \n\n```bash\nnpm install laravel-vapor\n```\n\nAnd you'll need to install a PHP dependency for working with S3: \n\n```bash\ncomposer require league/flysystem-aws-s3-v3\n```\n\n## Making the frontend work\n\nTo start, let's add an extra input to our `<form>`. This input will keep track of which attachments are currently in the Trix editor, which we'll need to copy into permanent storage once the form is submitted. \n\n```bash\n<input type=\"hidden\" name=\"trix_files\" value=\"[]\" />\n```\n\n*Notice that the value is an empty array if no attachments are ever added.* \n\nHere's all the client-side javascript that makes uploading files work. I'll explain it below. \n\n```javascript\nwindow.Vapor = require('laravel-vapor')\n\ndocument.addEventListener('trix-attachment-add', event => {\n  if(event.attachment.file) {\n    const attachment = event.attachment\n\n    Vapor.store(attachment.file, {\n      progress: amount => attachment.setUploadProgress(amount * 100)\n\t})\n      .then(response => {\n        attachment.setAttributes({\n          key: response.key,\n          url: response.url.split('?')[0]\n        })\n\n        updateTrixFiles(event)\n    })\n  }\n})\n\nconst updateTrixFiles = event => {\n  const allAttachments = event.attachment.attachmentManager.managedAttachments\n  const keys = Object.keys(allAttachments).map(id => allAttachments[id].attachment.attributes.values.key)\n\n  const input = document.querySelector('input[name=\"trix_files\"]')\n  input.value = JSON.stringify(keys)\n}\n\ndocument.addEventListener('trix-attachment-remove', updateTrixFiles)\n```\n\nYou'll see that this utilizes the `laravel-vapor` npm package we installed earlier. \n\nWhen there's a new attachment (event `trix-attachment-add`), we store the file (`attachment.file`) and report its upload progress to the Trix UI. \n\nAfter it's uploaded, we give Trix its \"key\" (where the attachment is stored in the bucket, like `tmp/random-filename`) and the URL that Trix should use to show it in the editor (the URL provided by Vapor has a bunch of query strings that interfere, so we remove those first). \n\nThen, once the attachment's been uploaded, we check which files are currently in the Trix document. The `updateTrixFiles` function uses Trix's attachment manager to find the `key` of each attachment (which we provided earlier using `attachment.setAttributes`). It then populates the `trix_files` input, so the backend will know which files need to be persisted. \n\nWhen an attachment is removed from the Trix editor (event `trix-attachment-remove`), we make sure to update the `trix_files` hidden input once again, to make sure we have the most up-to-date list of attachments that are still in the editor. \n\n## Making the backend work\n\nWhen this form is submitted, we have two pieces of data we need to worry about:\n\n* `body` contains the Trix HTML\n* `trix_files` includes the list of temporary files in S3 we now need to copy into permanent S3 storage (since remember, `tmp/` gets erased after 24 hours)\n\nTo persist the files in S3, we use the `Storage` facade in our controller: \n\n```php\nuse Illuminate\\Support\\Facades\\Storage;\n\n$files = json_decode(request('trix_files'));\n\nforeach($files as $path) {\n\tStorage::copy($path, str_replace('tmp/', '', $path);\n}\n```\n\nNow, those files are copied out of `tmp/` into the root folder in S3, where they won't be deleted after 24 hours.\n\nLastly, we need to deal with the fact that the Trix HTML (submitted to the controller as `body`) still uses the S3 URLs with `tmp/` in them (we provided the temporary URL to `attachment.setAttributes` on the frontend because the permanent URL didn't exist yet). \n\nTo fix this, we can find and replace using a regex: \n\n```php\n$body = preg_replace('/tmp\\//', '', request('body'));\n```\n\nNow, the images in the HTML output point to the non-temporary copy of the attachment in S3. \n\n```\nBefore replacement: https://my-bucket.s3.amazonaws.com/tmp/random-filename\n After replacement: https://my-bucket.s3.amazonaws.com/random-filename\n```"
}