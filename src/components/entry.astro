---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import Prose from "./prose.astro";
import RelatedPosts from "./related-posts.astro";

interface Props {
  entry: CollectionEntry<"posts"> | CollectionEntry<"pages">;
  preview?: boolean;
}

const { entry } = Astro.props;

const title = entry.collection === "posts" ? entry.data.title : undefined;
const date = entry.collection === "posts" ? entry.data.date : undefined;
const hasCoverImage =
  (await import(`../cover-images/${entry.slug}.png`).catch(() => null)) !==
  null;
const coverImageImport = hasCoverImage
  ? import(`../cover-images/${entry.slug}.png`)
  : null;

const coverImageAtBottom = ["now"].includes(entry.slug);

const hasFrontmatter = (hasCoverImage && !coverImageAtBottom) || title || date;

const { Content } = await entry.render();
---

{
  entry.collection === "posts" && entry.data.draft && (
    <p class="mb-10 bg-brand-yellow-light text-brand-red border border-brand-red px-2 py-0.5 font-medium max-w-max mx-auto">
      draft post
    </p>
  )
}

{
  hasFrontmatter && (
    <>
      {hasCoverImage && (
        <Image
          src={coverImageImport!}
          alt=""
          class="max-h-48 sm:max-h-54 w-auto mx-auto"
        />
      )}

      {title && (
        <h1
          class:list={[
            "text-gray-950 text-3xl sm:text-4xl font-h1 font-bold uppercase text-center text-balance",
            hasCoverImage && "mt-12",
          ]}
        >
          {title}
        </h1>
      )}

      {date && (
        <time class="block mt-2 text-sm font-medium text-gray-500 text-center">
          {date.toLocaleString("en-US", {
            timeZone: "UTC",
            month: "long",
            day: "numeric",
            year: "numeric",
          })}
        </time>
      )}
    </>
  )
}

<div class:list={[hasFrontmatter ? "mt-10" : "mt-2"]}>
  <Prose>
    <Content />
  </Prose>

  {
    entry.collection === "posts" && (
      <RelatedPosts
        entry={entry}
        class="lg:hidden mt-10 pt-10 border-t border-gray-100"
      />
    )
  }

  {
    coverImageAtBottom && (
      <Image
        src={coverImageImport!}
        alt=""
        class="mt-18 max-h-48 sm:max-h-54 w-auto mx-auto"
      />
    )
  }
</div>
